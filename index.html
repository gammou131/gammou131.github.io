<!DOCTYPE html>
<html>
<head>
    <title>함선 워프 속도 계산기</title>
    <style>
        body { font-family: sans-serif; padding: 15px; }
        h1 .title-note { /* 제목 옆 설명 스타일 */
            font-size: 0.6em;
            color: #555;
            font-weight: normal;
            margin-left: 5px; /* 제목과의 간격 */
        }
        .ship-selection { margin-bottom: 15px; border: 1px solid #ccc; padding: 10px; border-radius: 8px; background-color: #f9f9f9; }
        .ship-info { display: flex; align-items: center; margin-bottom: 5px; }
        .ship-info img { width: 50px; height: 50px; margin-right: 10px; border-radius: 4px; object-fit: cover; /* 이미지 비율 유지 */ }
        .reinforcement-container { margin-left: 10px; display: inline-block; }
        #cost-display { margin-top: 10px; font-weight: bold; }
        #result { margin-top: 20px; font-weight: bold; border-top: 1px solid #eee; padding-top: 15px; }
        .warning { color: red; }
        label { margin-right: 5px; }
        select, input[type="number"] { margin-right: 10px; padding: 5px; border-radius: 4px; border: 1px solid #ccc; }
        button { padding: 8px 15px; margin-right: 5px; border: none; border-radius: 4px; background-color: #007bff; color: white; cursor: pointer; transition: background-color 0.2s; /* 부드러운 효과 */ }
        button:hover { background-color: #0056b3; }
        button.remove-btn { background-color: #dc3545; } /* 삭제 버튼 스타일 */
        button.remove-btn:hover { background-color: #c82333; }
        .control-panel {
            margin-bottom: 20px;
            padding: 15px; /* 패딩 조정 */
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #eee;
            display: flex;
            flex-direction: column; /* 세로 정렬 */
            gap: 10px; /* 각 컨트롤 그룹 사이 간격 */
        }
        .control-group { /* 각 컨트롤 라인을 그룹화 */
            display: flex;
            align-items: center;
            flex-wrap: wrap; /* 작은 화면에서 줄바꿈 허용 */
            gap: 5px;
        }
        .control-panel label { margin-bottom: 0; }
        .control-panel button { background-color: #6c757d; }
        .control-panel button.active { background-color: #28a745; }
        #reinforcement-info { font-weight: bold; color: #17a2b8; margin-left: 10px; }
        .error-placeholder { color: #dc3545; font-style: italic; }
        #max-cost-input, #target-warp-input { width: 80px; /* 입력 필드 너비 조정 */ }
        .recommendation-note { /* 추천 문구 스타일 */
            font-size: 0.9em;
            color: #6c757d; /* 회색 계열 */
            margin-left: 0px; /* 입력 필드와의 간격 제거 (gap으로 처리) */
        }
    </style>
</head>
<body>
    <h1>함선 워프 속도 계산기 <small class="title-note">(본 계산기는 함선별 최대 워프 속도를 기준으로 합니다.)</small></h1>

    <div class="control-panel">
        <div class="control-group">
            <label>증원 한도:</label>
            <button id="limit-5" onclick="setReinforcementLimit(5)">5대</button>
            <button id="limit-9" onclick="setReinforcementLimit(9)">9대</button>
            <div id="reinforcement-info">남은 슬롯: 5</div>
        </div>
        <div class="control-group">
            <label for="max-cost-input">본인의 단일함대 최대 지휘포인트:</label>
            <input type="number" id="max-cost-input" value="400" min="0" oninput="updateMaxCost()">
        </div>
        <div class="control-group">
            <label for="target-warp-input">목표 워프 속도:</label>
            <input type="number" id="target-warp-input" value="4240" min="0" step="1" oninput="updateTargetWarpSpeed()">
            <small class="recommendation-note">(4000-4500 사이를 추천합니다.)</small>
        </div>
    </div>

    <div id="shipSelections">
        </div>

    <button onclick="addShipSelection()">함선 추가</button>
    <button onclick="calculateBestFG()">최적 FG 조합 계산</button>

    <div id="cost-display">현재 지휘포인트: 0</div>
    <div id="result"></div>

    <script>
        const shipsData = {
            // ... (함선 데이터는 이전과 동일하게 유지) ...
             "호위함": [
                {
                    name: "제노스팅어",
                    subModels: [
                        { name: "특수형", warpSpeed: 4600, cost: 8, image: "xenostinger_special.png" },
                        { name: "방공형", warpSpeed: 4600, cost: 6, image: "xenostinger_aa.png" }
                    ]
                },
                {
                    name: "이노스트란케비아",
                    subModels: [
                        { name: "방공형", warpSpeed: 4600, cost: 6, image: "inostrankevia_aa.png" },
                        { name: "공격형", warpSpeed: 4600, cost: 6, image: "inostrankevia_attack.png" },
                        { name: "특수형", warpSpeed: 4600, cost: 8, image: "inostrankevia_special.png" }
                    ]
                },
                {
                    name: "노마 M470",
                    subModels: [
                        { name: "공성형", warpSpeed: 4000, cost: 6, image: "noma_m470_siege.png" }, // 코스트 정보 없음 -> 임의로 6 부여
                        { name: "지원형", warpSpeed: 4000, cost: 6, image: "noma_m470_support.png" }, // 코스트 정보 없음 -> 임의로 6 부여
                        { name: "방공형", warpSpeed: 4000, cost: 6, image: "noma_m470_aa.png" }
                    ]
                },
                {
                    name: "루비",
                    subModels: [
                        { name: "레일건형", warpSpeed: 5175, cost: 5, image: "ruby_railgun.png" },
                        { name: "이온캐논형", warpSpeed: 5175, cost: 8, image: "ruby_ion.png" },
                        { name: "방어형", warpSpeed: 5175, cost: 5, image: "ruby_defense.png" }
                    ]
                },
                {
                    name: "비의 바다",
                    subModels: [
                        { name: "레일건형", warpSpeed: 5175, cost: 6, image: "sea_of_rain_railgun.png" },
                        { name: "펄스캐논형", warpSpeed: 5850, cost: 8, image: "sea_of_rain_pulse.png" }
                    ]
                },
                {
                    name: "맑음의 바다",
                    subModels: [
                        { name: "대함형", warpSpeed: 5175, cost: 5, image: "sea_of_serenity_anti_ship.png" },
                        { name: "미사일형", warpSpeed: 5175, cost: 5, image: "sea_of_serenity_missile.png" },
                        { name: "방공형", warpSpeed: 5175, cost: 5, image: "sea_of_serenity_aa.png" }
                    ]
                },
                {
                    name: "구름의 바다",
                    subModels: [
                        { name: "돌격형", warpSpeed: 4500, cost: 4, image: "sea_of_clouds_assault.png" },
                        { name: "방공형", warpSpeed: 4500, cost: 4, image: "sea_of_clouds_aa.png" }
                    ]
                },
                {
                    name: "고요의 바다",
                    subModels: [
                        { name: "종합형", warpSpeed: 5750, cost: 4, image: "sea_of_tranquility_comprehensive.png" },
                        { name: "펄스캐논형", warpSpeed: 5750, cost: 4, image: "sea_of_tranquility_pulse.png" },
                        { name: "방공형", warpSpeed: 5750, cost: 4, image: "sea_of_tranquility_aa.png" }
                    ]
                },
                {
                    name: "릴리아트",
                    subModels: [
                        { name: "대함형", warpSpeed: 4600, cost: 4, image: "liliyat_anti_ship.png" },
                        { name: "어뢰형", warpSpeed: 4600, cost: 4, image: "liliyat_torpedo.png" },
                        { name: "스텔스형", warpSpeed: 4600, cost: 4, image: "liliyat_stealth.png" }
                    ]
                },
                {
                    name: "카릴리온",
                    subModels: [
                        { name: "정찰형", warpSpeed: 6760, cost: 4, image: "carillon_recon.png" },
                        { name: "중형캐논형", warpSpeed: 5462, cost: 5, image: "carillon_medium_cannon.png" },
                        { name: "특수형", warpSpeed: 6760, cost: 5, image: "carillon_special.png" }
                    ]
                },
                 { # 지르콘 데이터 추가
                    name: "지르콘",
                    subModels: [
                        { name: "펄스형", warpSpeed: 6000, cost: 5, image: "zircon_pulse.png" },
                        { name: "레일건형", warpSpeed: 6000, cost: 5, image: "zircon_railgun.png" },
                        { name: "방공형", warpSpeed: 6000, cost: 5, image: "zircon_aa.png" }
                    ]
                }


            ],
            "구축함": [
                {
                    name: "타우루스",
                    subModels: [
                        { name: "공격형", warpSpeed: 3737, cost: 11, image: "taurus_attack.png" },
                        { name: "돌격형", warpSpeed: 3737, cost: 11, image: "taurus_assault.png" },
                        { name: "방어형", warpSpeed: 3737, cost: 8, image: "taurus_defense.png" }
                    ]
                },
                {
                    name: "툰드라",
                    subModels: [
                        { name: "지원형", warpSpeed: 3500, cost: 9, image: "tundra_support.png" },
                        { name: "수송형", warpSpeed: 3500, cost: 9, image: "tundra_transport.png" }
                    ]
                },
                {
                    name: "알다브라",
                    subModels: [
                        { name: "일반형", warpSpeed: 3737, cost: 8, image: "aldabra_standard.png" },
                        { name: "장갑형", warpSpeed: 3737, cost: 8, image: "aldabra_armored.png" }
                    ]
                },
                {
                    name: "세레스",
                    subModels: [
                        { name: "수송형", warpSpeed: 5525, cost: 8, image: "ceres_transport.png" },
                        { name: "지원형", warpSpeed: 5525, cost: 8, image: "ceres_support.png" },
                        { name: "전술형", warpSpeed: 5525, cost: 8, image: "ceres_tactical.png" }
                    ]
                },
                {
                    name: "에리스",
                    subModels: [
                        { name: "캐논형", warpSpeed: 5175, cost: 7, image: "eris_cannon.png" },
                        { name: "장갑형", warpSpeed: 5175, cost: 7, image: "eris_armored.png" },
                        { name: "중형캐논형", warpSpeed: 5175, cost: 9, image: "eris_medium_cannon.png" }
                    ]
                },
                {
                    name: "콰오아",
                    subModels: [
                        { name: "레일건형", warpSpeed: 5525, cost: 6, image: "quaoar_railgun.png" },
                        { name: "어뢰형", warpSpeed: 5525, cost: 6, image: "quaoar_torpedo.png" }
                    ]
                },
                {
                    name: "가디언",
                    subModels: [
                        { name: "지원형", warpSpeed: 4225, cost: 9, image: "guardian_support.png" },
                        { name: "수륙양용형", warpSpeed: 4225, cost: 14, image: "guardian_amphibious.png" },
                        { name: "펄스캐논형", warpSpeed: 4225, cost: 9, image: "guardian_pulse.png" }
                    ]
                },
                {
                    name: "윙드 후사르",
                    subModels: [
                        { name: "대함형", warpSpeed: 4550, cost: 6, image: "winged_hussar_anti_ship.png" },
                        { name: "종합형", warpSpeed: 5525, cost: 6, image: "winged_hussar_comprehensive.png" },
                        { name: "방공형", warpSpeed: 5525, cost: 6, image: "winged_hussar_aa.png" }
                    ]
                },
                {
                    name: "AC721",
                    subModels: [
                        { name: "일반형", warpSpeed: 5200, cost: 8, image: "ac721_standard.png" },
                        { name: "미사일형", warpSpeed: 5200, cost: 8, image: "ac721_missile.png" },
                        { name: "수송형", warpSpeed: 5200, cost: 12, image: "ac721_transport.png" }
                    ]
                }
            ],
            "순양함": [
                {
                    name: "라이트콘",
                    subModels: [
                        { name: "일반형", warpSpeed: 2925, cost: 20, image: "lightcone_standard.png" },
                        { name: "방공형", warpSpeed: 2925, cost: 20, image: "lightcone_aa.png" },
                        { name: "돌격형", warpSpeed: 2925, cost: 20, image: "lightcone_assault.png" }
                    ]
                },
                {
                    name: "키메라",
                    subModels: [
                        { name: "탄도형", warpSpeed: 2587, cost: 18, image: "chimera_ballistic.png" },
                        { name: "중형캐논형", warpSpeed: 2587, cost: 20, image: "chimera_medium_cannon.png" },
                        { name: "방어형", warpSpeed: 2587, cost: 20, image: "chimera_defense.png" }
                    ]
                },
                {
                    name: "코나마라 카오스",
                    subModels: [
                        { name: "레일건형", warpSpeed: 2925, cost: 20, image: "conamara_chaos_railgun.png" },
                        { name: "플라즈마형", warpSpeed: 2925, cost: 20, image: "conamara_chaos_plasma.png" }
                    ]
                },
                {
                    name: "칼리스토",
                    subModels: [
                        { name: "어뢰형", warpSpeed: 2600, cost: 20, image: "callisto_torpedo.png" },
                        { name: "대함형", warpSpeed: 2600, cost: 20, image: "callisto_anti_ship.png" },
                        { name: "지원형", warpSpeed: 2600, cost: 20, image: "callisto_support.png" }
                    ]
                },
                {
                    name: "이오",
                    subModels: [
                        { name: "이온캐논형", warpSpeed: 3737, cost: 18, image: "io_ion.png" },
                        { name: "대함형", warpSpeed: 3737, cost: 18, image: "io_anti_ship.png" },
                        { name: "공성형", warpSpeed: 3737, cost: 18, image: "io_siege.png" }
                    ]
                },
                {
                    name: "예거",
                    subModels: [
                        { name: "지원형", warpSpeed: 3250, cost: 20, image: "jaeger_support.png" },
                        { name: "대함형", warpSpeed: 3250, cost: 18, image: "jaeger_anti_ship.png" }
                    ]
                },
                {
                    name: "레인저",
                    subModels: [
                        { name: "종합형", warpSpeed: 3250, cost: 18, image: "ranger_comprehensive.png" },
                        { name: "이온캐논형", warpSpeed: 2600, cost: 18, image: "ranger_ion.png" }
                    ]
                },
                {
                    name: "프레데터",
                    subModels: [
                        { name: "일반형", warpSpeed: 3250, cost: 18, image: "predator_standard.png" },
                        { name: "전술형", warpSpeed: 3250, cost: 18, image: "predator_tactical.png" },
                        { name: "방공형", warpSpeed: 3250, cost: 18, image: "predator_aa.png" }
                    ]
                },
                {
                    name: "카스",
                    subModels: [
                        { name: "종합형", warpSpeed: 3250, cost: 18, image: "kas_comprehensive.png" },
                        { name: "포격형", warpSpeed: 3250, cost: 18, image: "kas_artillery.png" },
                        { name: "수송형", warpSpeed: 3250, cost: 18, image: "kas_transport.png" },
                        { name: "지원형", warpSpeed: 3250, cost: 18, image: "kas_support.png" }
                    ]
                },
                {
                    name: "KCCPV2.0",
                    subModels: [
                        { name: "종합형", warpSpeed: 4225, cost: 16, image: "kccpv2_comprehensive.png" },
                        { name: "펄스캐논형", warpSpeed: 4225, cost: 16, image: "kccpv2_pulse.png" },
                        { name: "레일건형", warpSpeed: 4225, cost: 16, image: "kccpv2_railgun.png" },
                        { name: "수송형", warpSpeed: 4225, cost: 16, image: "kccpv2_transport.png" }
                    ]
                }
            ],
            "전투순양함": [
                {
                    name: "플루투스의 방패",
                    subModels: [
                        { name: "표준형", warpSpeed: 1625, cost: 35, image: "plutus_shield_standard.png" }
                    ]
                },
                {
                    name: "우라노스의 창",
                    subModels: [
                        { name: "표준형", warpSpeed: 1625, cost: 35, image: "uranus_lance_standard.png" }
                    ]
                },
                {
                    name: "이터널 스톰",
                    subModels: [
                        { name: "표준형", warpSpeed: 2925, cost: 32, image: "eternal_storm_standard.png" }
                    ]
                },
                {
                    name: "콘스탄티누스 대제",
                    subModels: [
                        { name: "표준형", warpSpeed: 2600, cost: 35, image: "constantinus_the_great_standard.png" }
                    ]
                },
                {
                    name: "썬더볼트의 별",
                    subModels: [
                        { name: "표준형", warpSpeed: 2600, cost: 35, image: "thunderbolt_star_standard.png" }
                    ]
                },
                {
                    name: "ST59",
                    subModels: [
                        { name: "표준형", warpSpeed: 2925, cost: 28, image: "st59_battlecruiser_standard.png" }
                    ]
                }
            ],
            "항공모함": [
                {
                    name: "에버 스카이",
                    subModels: [
                        { name: "표준형", warpSpeed: 2275, cost: 40, image: "ever_sky_standard.png" }
                    ]
                },
                {
                    name: "마샬크럭스",
                    subModels: [
                        { name: "표준형", warpSpeed: 2600, cost: 40, image: "marshall_crux_standard.png" }
                    ]
                },
                {
                    name: "솔라 웨일",
                    subModels: [
                        { name: "표준형", warpSpeed: 1625, cost: 55, image: "solar_whale_standard.png" }
                    ]
                },
                {
                    name: "CV3000",
                    subModels: [
                        { name: "표준형", warpSpeed: 2600, cost: 40, image: "cv3000_standard.png" }
                    ]
                }
            ],
            "지원함": [
                {
                    name: "에디아카라",
                    subModels: [
                        { name: "표준형", warpSpeed: 2730, cost: 40, image: "ediakara_standard.png" }
                    ]
                },
                {
                    name: "FSV830",
                    subModels: [
                        { name: "표준형", warpSpeed: 3640, cost: 0, image: "fsv830_standard.png" } // 코스트 정보 없음 -> 0으로 유지
                    ]
                }
            ]
        };

        let shipSelectionCounter = 0;
        let currentReinforcementLimit = 5;
        let currentMaxCost = 400; // 최대 지휘 포인트
        let currentTargetWarpSpeed = 4240; // 목표 워프 속도
        const shipTypes = Object.keys(shipsData);
        const multipurposeFGWarpSpeed = 5750;
        const reconFGWarpSpeed = 6760;
        const fgCost = 3;
        const maxFGCount = 15;
        const imagePlaceholderBaseUrl = "https://placehold.co/50x50/cccccc/ffffff?text=No+Img";

        // 이미지 로딩 실패 처리
        function handleImageError(imgElement) {
            console.warn(`이미지 로드 실패: ${imgElement.src}. 플레이스홀더 사용.`);
            imgElement.src = imagePlaceholderBaseUrl;
            imgElement.onerror = null;
        }

        // 증원 한도 설정
        function setReinforcementLimit(limit) {
            currentReinforcementLimit = limit;
            document.getElementById('limit-5').classList.toggle('active', limit === 5);
            document.getElementById('limit-9').classList.toggle('active', limit === 9);
            updateReinforcementInfo();
            calculateTotalCost();
            validateReinforcementSelection();
        }

        // 최대 지휘 포인트 업데이트
        function updateMaxCost() {
            const inputElement = document.getElementById('max-cost-input');
            const newMaxCost = parseInt(inputElement.value);
            if (!isNaN(newMaxCost) && newMaxCost >= 0) {
                currentMaxCost = newMaxCost;
                const resultDiv = document.getElementById("result");
                if (resultDiv.innerHTML.includes("최적 조합:")) {
                     calculateBestFG();
                } else {
                     calculateTotalCost();
                }
            } else {
                console.warn("유효하지 않은 최대 지휘 포인트 값:", inputElement.value);
            }
        }

        // 목표 워프 속도 업데이트
        function updateTargetWarpSpeed() {
            const inputElement = document.getElementById('target-warp-input');
            const newTargetSpeed = parseInt(inputElement.value); // 정수로 처리
            if (!isNaN(newTargetSpeed) && newTargetSpeed >= 0) {
                currentTargetWarpSpeed = newTargetSpeed;
                // FG 결과가 표시된 상태라면 즉시 재계산하여 반영
                const resultDiv = document.getElementById("result");
                if (resultDiv.innerHTML.includes("최적 조합:")) {
                    calculateBestFG();
                }
            } else {
                console.warn("유효하지 않은 목표 워프 속도 값:", inputElement.value);
            }
        }


        // 남은 증원 슬롯 업데이트
        function updateReinforcementInfo() {
            let usedReinforcementSlots = 0;
            const shipSelections = document.querySelectorAll(".ship-selection");
            shipSelections.forEach(selection => {
                const quantityInput = selection.querySelector("input[type='number']");
                const reinforcementCheckbox = selection.querySelector("input[type='checkbox']");
                if (reinforcementCheckbox?.checked && quantityInput) {
                    usedReinforcementSlots += parseInt(quantityInput.value) || 0;
                }
            });
            const remainingSlots = currentReinforcementLimit - usedReinforcementSlots;
            const infoDiv = document.getElementById("reinforcement-info");
            infoDiv.innerText = `남은 슬롯: ${remainingSlots}`;
            infoDiv.classList.toggle('warning', remainingSlots < 0);
        }

        // 증원 선택 유효성 검사
        function validateReinforcementSelection() {
            let usedReinforcementSlots = 0;
            const shipSelections = document.querySelectorAll(".ship-selection");
            let excessShipsRemoved = false;

            shipSelections.forEach(selection => {
                const quantityInput = selection.querySelector("input[type='number']");
                const reinforcementCheckbox = selection.querySelector("input[type='checkbox']");
                const quantity = parseInt(quantityInput.value) || 0;

                if (reinforcementCheckbox?.checked && quantityInput) {
                    if (usedReinforcementSlots + quantity > currentReinforcementLimit) {
                        reinforcementCheckbox.checked = false;
                        excessShipsRemoved = true;
                        console.warn(`증원 한도(${currentReinforcementLimit}) 초과로 함선(${selection.id})의 증원 설정을 해제했습니다.`);
                    } else {
                        usedReinforcementSlots += quantity;
                    }
                }
            });

            if (excessShipsRemoved) {
                alert(`변경된 증원 한도(${currentReinforcementLimit}대)에 맞게 일부 함선의 증원 설정이 해제되었습니다.`);
                updateReinforcementInfo();
                calculateTotalCost();
            }
        }


        // 총 지휘 포인트 계산
        function calculateTotalCost(multipurposeFGCount = 0, reconFGCount = 0) {
            let calculatedCost = 0;
            let usedReinforcementSlots = 0;
            const shipSelections = document.querySelectorAll(".ship-selection");

            shipSelections.forEach(selection => {
                const shipTypeSelect = selection.querySelector("select[id^='ship-type-']");
                const shipNameSelect = selection.querySelector("select[id^='ship-name-']");
                const subModelSelect = selection.querySelector("select[id^='sub-model-']");
                const quantityInput = selection.querySelector("input[type='number']");
                const reinforcementCheckbox = selection.querySelector("input[type='checkbox']");

                if (shipTypeSelect?.value && shipNameSelect?.value && subModelSelect?.value !== "" && quantityInput) {
                    const selectedShipTypeName = shipTypeSelect.value;
                    const selectedShipName = shipNameSelect.value;
                    const selectedSubModelIndex = parseInt(subModelSelect.value);
                    const quantity = parseInt(quantityInput.value) || 0;

                    const selectedShipTypeData = shipsData[selectedShipTypeName];
                    const selectedShip = selectedShipTypeData?.find(ship => ship.name === selectedShipName);
                    const subModel = selectedShip?.subModels?.[selectedSubModelIndex];

                    if (subModel) {
                        if (reinforcementCheckbox?.checked && (usedReinforcementSlots + quantity <= currentReinforcementLimit)) {
                            usedReinforcementSlots += quantity;
                        } else {
                            calculatedCost += (subModel.cost || 0) * quantity;
                        }
                    }
                }
            });

            calculatedCost += multipurposeFGCount * fgCost;
            calculatedCost += reconFGCount * fgCost;

            const costDisplay = document.getElementById("cost-display");
            if (multipurposeFGCount === 0 && reconFGCount === 0) {
                 costDisplay.innerText = `현재 지휘포인트: ${calculatedCost}`;
            }
            costDisplay.classList.toggle("warning", calculatedCost > currentMaxCost);

            updateReinforcementInfo();

            return calculatedCost;
        }

        // 새 함선 선택 추가
        function addShipSelection() {
            shipSelectionCounter++;
            const container = document.getElementById("shipSelections");
            const div = document.createElement("div");
            div.classList.add("ship-selection");
            div.id = `ship-selection-${shipSelectionCounter}`;
            div.innerHTML = `
                <label for="ship-type-${shipSelectionCounter}">함종:</label>
                <select id="ship-type-${shipSelectionCounter}" onchange="populateShipNames(${shipSelectionCounter})">
                    <option value="">선택하세요</option>
                    ${shipTypes.map(type => `<option value="${type}">${type}</option>`).join('')}
                </select>
                <label for="ship-name-${shipSelectionCounter}">함선:</label>
                <select id="ship-name-${shipSelectionCounter}" onchange="populateSubModels(${shipSelectionCounter})">
                    <option value="">선택하세요</option>
                </select>
                <label for="sub-model-${shipSelectionCounter}">서브모델:</label>
                <select id="sub-model-${shipSelectionCounter}" onchange="updateShipInfo(${shipSelectionCounter})">
                    <option value="">선택하세요</option>
                </select>
                <div id="ship-info-${shipSelectionCounter}" style="margin-top: 10px;"></div>
                <label for="quantity-${shipSelectionCounter}">갯수:</label>
                <input type="number" id="quantity-${shipSelectionCounter}" value="1" min="1" oninput="calculateTotalCost()">
                <div class="reinforcement-container">
                    <input type="checkbox" id="reinforcement-${shipSelectionCounter}" onclick="toggleReinforcement(${shipSelectionCounter})">
                    <label for="reinforcement-${shipSelectionCounter}">증원</label>
                </div>
                <button onclick="removeShipSelection(${shipSelectionCounter})" class="remove-btn" style="float: right;">삭제</button>
            `;
            container.appendChild(div);
            calculateTotalCost();
        }

        // 함선 선택 삭제
        function removeShipSelection(id) {
            const selectionToRemove = document.getElementById(`ship-selection-${id}`);
            if (selectionToRemove) {
                selectionToRemove.remove();
                calculateTotalCost();
            }
        }

        // 함선 이름 목록 채우기
        function populateShipNames(id) {
            const shipTypeSelect = document.getElementById(`ship-type-${id}`);
            const shipNameSelect = document.getElementById(`ship-name-${id}`);
            const subModelSelect = document.getElementById(`sub-model-${id}`);
            const infoDiv = document.getElementById(`ship-info-${id}`);
            const selectedShipType = shipTypeSelect.value;

            shipNameSelect.innerHTML = '<option value="">선택하세요</option>';
            subModelSelect.innerHTML = '<option value="">선택하세요</option>';
            infoDiv.innerHTML = "";

            if (selectedShipType && shipsData[selectedShipType]) {
                const sortedShips = [...shipsData[selectedShipType]].sort((a, b) => a.name.localeCompare(b.name));
                sortedShips.forEach(ship => {
                    const option = document.createElement("option");
                    option.value = ship.name;
                    option.textContent = ship.name;
                    shipNameSelect.appendChild(option);
                });
            }
            calculateTotalCost();
        }

        // 서브모델 목록 채우기
        function populateSubModels(id) {
            const shipTypeSelect = document.getElementById(`ship-type-${id}`);
            const shipNameSelect = document.getElementById(`ship-name-${id}`);
            const subModelSelect = document.getElementById(`sub-model-${id}`);
            const infoDiv = document.getElementById(`ship-info-${id}`);
            const selectedShipType = shipTypeSelect.value;
            const selectedShipName = shipNameSelect.value;

            subModelSelect.innerHTML = '<option value="">선택하세요</option>';
            infoDiv.innerHTML = "";

            if (selectedShipType && selectedShipName && shipsData[selectedShipType]) {
                const selectedShip = shipsData[selectedShipType].find(ship => ship.name === selectedShipName);
                if (selectedShip?.subModels) {
                     const sortedSubModels = [...selectedShip.subModels].sort((a, b) => a.name.localeCompare(b.name));
                     sortedSubModels.forEach((subModel) => {
                         const originalIndex = selectedShip.subModels.findIndex(original => original.name === subModel.name);
                         const option = document.createElement("option");
                         option.value = originalIndex;
                         option.textContent = subModel.name;
                         subModelSelect.appendChild(option);
                     });
                }
            }
            updateShipInfo(id);
        }

        // 함선 정보 업데이트
        function updateShipInfo(id) {
            const shipTypeSelect = document.getElementById(`ship-type-${id}`);
            const shipNameSelect = document.getElementById(`ship-name-${id}`);
            const subModelSelect = document.getElementById(`sub-model-${id}`);
            const infoDiv = document.getElementById(`ship-info-${id}`);

            const selectedShipTypeName = shipTypeSelect.value;
            const selectedShipName = shipNameSelect.value;
            const selectedSubModelIndexValue = subModelSelect.value;

            infoDiv.innerHTML = "";

            if (selectedShipTypeName && selectedShipName && selectedSubModelIndexValue !== "") {
                 const selectedShipTypeData = shipsData[selectedShipTypeName];
                 const selectedShip = selectedShipTypeData?.find(ship => ship.name === selectedShipName);
                 const subModelIndex = parseInt(selectedSubModelIndexValue);
                 const subModel = selectedShip?.subModels?.[subModelIndex];

                 if (subModel) {
                    const imagePath = `https://via.placeholder.com/50/cccccc/ffffff.png?text=${selectedShipName.substring(0,3)}`;

                    infoDiv.innerHTML = `
                        <div class="ship-info">
                            <img src="${imagePath}" alt="${selectedShipName} ${subModel.name}" onerror="handleImageError(this)">
                            <div>
                                <p><strong>${selectedShipName} (${subModel.name})</strong></p>
                                <p>워프 속도: ${subModel.warpSpeed || 'N/A'}</p>
                                <p>지휘 포인트: ${subModel.cost || 'N/A'}</p>
                            </div>
                        </div>
                    `;
                 } else {
                     infoDiv.innerHTML = `<p class="error-placeholder">서브모델 정보를 불러올 수 없습니다.</p>`;
                 }
            } else if (selectedShipName) {
                 infoDiv.innerHTML = `<p class="error-placeholder">서브모델을 선택해주세요.</p>`;
            }
            calculateTotalCost();
        }

        // 증원 체크박스 토글
        function toggleReinforcement(id) {
            const checkbox = document.getElementById(`reinforcement-${id}`);
            const currentSelection = document.getElementById(`ship-selection-${id}`);
            const currentQuantityInput = currentSelection.querySelector("input[type='number']");
            const currentShipQuantity = parseInt(currentQuantityInput.value) || 0;

            if (checkbox.checked) {
                let usedReinforcementSlots = 0;
                const shipSelections = document.querySelectorAll(".ship-selection");
                shipSelections.forEach(selection => {
                    const quantityInput = selection.querySelector("input[type='number']");
                    const reinforcementCheckbox = selection.querySelector("input[type='checkbox']");
                    if (reinforcementCheckbox?.checked && reinforcementCheckbox.id !== checkbox.id && quantityInput) {
                        usedReinforcementSlots += parseInt(quantityInput.value) || 0;
                    }
                });

                if (usedReinforcementSlots + currentShipQuantity > currentReinforcementLimit) {
                    alert(`증원 함선은 최대 ${currentReinforcementLimit}대까지 선택 가능합니다. 현재 ${usedReinforcementSlots}대 선택됨.`);
                    checkbox.checked = false;
                }
            }
            calculateTotalCost();
        }

        // 최적 FG 조합 계산
        function calculateBestFG() {
            let totalShipWarpSpeed = 0;
            let totalShips = 0;
            const shipSelections = document.querySelectorAll(".ship-selection");

            shipSelections.forEach(selection => {
                const shipTypeSelect = selection.querySelector("select[id^='ship-type-']");
                const shipNameSelect = selection.querySelector("select[id^='ship-name-']");
                const subModelSelect = selection.querySelector("select[id^='sub-model-']");
                const quantityInput = selection.querySelector("input[type='number']");

                if (shipTypeSelect?.value && shipNameSelect?.value && subModelSelect?.value !== "" && quantityInput) {
                    const selectedShipTypeName = shipTypeSelect.value;
                    const selectedShipName = shipNameSelect.value;
                    const selectedSubModelIndex = parseInt(subModelSelect.value);
                    const quantity = parseInt(quantityInput.value) || 0;

                    const selectedShipTypeData = shipsData[selectedShipTypeName];
                    const selectedShip = selectedShipTypeData?.find(ship => ship.name === selectedShipName);
                    const subModel = selectedShip?.subModels?.[selectedSubModelIndex];

                    if (subModel) {
                        totalShipWarpSpeed += (subModel.warpSpeed || 0) * quantity;
                        totalShips += quantity;
                    }
                }
            });

            const resultDiv = document.getElementById("result");
            if (totalShips === 0) {
                resultDiv.innerHTML = "함선을 먼저 선택하고 수량을 입력해주세요.";
                calculateTotalCost(0, 0);
                return;
            }

            let baseAverageWarpSpeed = totalShipWarpSpeed / totalShips;
            let bestMultipurposeFGCount = -1;
            let bestReconFGCount = -1;
            let minWarpSpeedDiff = Infinity;

            // FG 조합 탐색: 목표 워프 속도(currentTargetWarpSpeed) 기준
            for (let mpFG = 0; mpFG <= maxFGCount; mpFG++) {
                for (let rFG = 0; rFG <= maxFGCount; rFG++) {
                    const currentTotalWarpSpeed = totalShipWarpSpeed + mpFG * multipurposeFGWarpSpeed + rFG * reconFGWarpSpeed;
                    const currentTotalShips = totalShips + mpFG + rFG;
                    if (currentTotalShips > 0) {
                        const currentAverageWarpSpeed = currentTotalWarpSpeed / currentTotalShips;
                        // currentTargetWarpSpeed 사용
                        const warpSpeedDiff = Math.abs(currentAverageWarpSpeed - currentTargetWarpSpeed);
                        if (warpSpeedDiff < minWarpSpeedDiff) {
                            minWarpSpeedDiff = warpSpeedDiff;
                            bestMultipurposeFGCount = mpFG;
                            bestReconFGCount = rFG;
                        } else if (warpSpeedDiff === minWarpSpeedDiff) {
                            if ((mpFG + rFG) < (bestMultipurposeFGCount + bestReconFGCount)) {
                                bestMultipurposeFGCount = mpFG;
                                bestReconFGCount = rFG;
                            }
                        }
                    }
                }
            }

             if (bestMultipurposeFGCount === -1) {
                 // currentTargetWarpSpeed 사용
                 resultDiv.innerHTML = `선택된 함선 평균 워프 속도: ${baseAverageWarpSpeed.toFixed(2)}<br>목표 속도(${currentTargetWarpSpeed})에 근접하는 FG 조합을 찾지 못했습니다.`;
                 calculateTotalCost(0, 0);
                 return;
             }

            const finalTotalWarpSpeed = totalShipWarpSpeed + bestMultipurposeFGCount * multipurposeFGWarpSpeed + bestReconFGCount * reconFGWarpSpeed;
            const finalTotalShips = totalShips + bestMultipurposeFGCount + bestReconFGCount;
            const finalAverageWarpSpeed = finalTotalShips > 0 ? finalTotalWarpSpeed / finalTotalShips : 0;

            const baseShipCost = calculateTotalCost(0, 0);
            const totalFGCost = (bestMultipurposeFGCount + bestReconFGCount) * fgCost;
            const finalTotalCost = baseShipCost + totalFGCost;

            let resultText = `선택된 함선 평균 워프 속도 (FG 제외): ${baseAverageWarpSpeed.toFixed(2)}<br>`;
            resultText += `<b>최적 조합: 다기능형 FG ${bestMultipurposeFGCount}대, 정찰형 FG ${bestReconFGCount}대</b><br>`;
            // currentTargetWarpSpeed 사용
            resultText += `결과 평균 워프 속도: <b>${finalAverageWarpSpeed.toFixed(2)}</b> (목표: ${currentTargetWarpSpeed})<br>`;
            resultText += `FG 총 지휘포인트: ${totalFGCost}<br>`;
            resultText += `현재 지휘포인트 (함선, 증원 제외): ${baseShipCost}<br>`;
            resultText += `<b>총 지휘포인트 (함선 + FG): ${finalTotalCost}</b>`;

            resultDiv.innerHTML = resultText;

            const costDisplay = document.getElementById("cost-display");
            costDisplay.innerText = `총 지휘포인트: ${finalTotalCost}`;
            costDisplay.classList.toggle("warning", finalTotalCost > currentMaxCost);
            resultDiv.classList.toggle("warning", finalTotalCost > currentMaxCost);
        }

        // 초기화
        function initializeCalculator() {
            document.getElementById('max-cost-input').value = currentMaxCost;
            document.getElementById('target-warp-input').value = currentTargetWarpSpeed; // 목표 워프 속도 필드 초기화
            setReinforcementLimit(5);
            addShipSelection();
        }

        // 페이지 로드 시 초기화
        window.onload = initializeCalculator;

    </script>
</body>
</html>

